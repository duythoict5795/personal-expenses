<!-- Chosen Palette: Calm Neutrals (Tailwind Slate) with Indigo (Income) and Red (Expense) accents. -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Thu Chi Cá Nhân</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .metric-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.25rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .metric-card:hover { transform: translateY(-2px); }
        .delete-btn {
            background-color: #fee2e2; color: #b91c1c; border: none; border-radius: 0.5rem; 
            width: 32px; height: 32px; line-height: 32px; font-weight: 700; font-size: 12px;
            cursor: pointer; transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center;
        }
        .delete-btn:hover { background-color: #fecaca; color: #991b1b; }
        .chart-container { position: relative; width: 100%; height: 300px; margin: auto; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
    </style>
</head>
<body class="p-3 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-6 md:mb-8">
            <h1 class="text-2xl md:text-4xl font-bold text-slate-800">Quản Lý Thu Chi</h1>
        </header>

        <!-- Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8">
            <div class="metric-card flex flex-row md:flex-col justify-between items-center md:items-start">
                <h2 class="text-xs md:text-sm font-medium text-slate-500 uppercase">Số Dư Hiện Tại</h2>
                <p id="balanceDisplay" class="text-2xl md:text-3xl font-bold text-slate-900 mt-0 md:mt-2">0 ₫</p>
            </div>
            <div class="metric-card flex flex-row md:flex-col justify-between items-center md:items-start">
                <h2 class="text-xs md:text-sm font-medium text-slate-500 uppercase">Tổng Thu</h2>
                <p id="incomeDisplay" class="text-2xl md:text-3xl font-bold text-emerald-600 mt-0 md:mt-2">0 ₫</p>
            </div>
            <div class="metric-card flex flex-row md:flex-col justify-between items-center md:items-start">
                <h2 class="text-xs md:text-sm font-medium text-slate-500 uppercase">Chi Tháng Này</h2>
                <p id="expenseDisplay" class="text-2xl md:text-3xl font-bold text-red-600 mt-0 md:mt-2">0 ₫</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 mb-6 md:mb-8">
            <!-- Form -->
            <div class="bg-white p-5 rounded-lg shadow-lg flex flex-col order-2 lg:order-1">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-4">Thêm Giao Dịch Mới</h2>
                <form id="transactionForm" class="flex flex-col flex-grow">
                    <fieldset class="mb-4" id="typeSelector">
                        <legend class="block text-sm font-medium text-slate-700 mb-2">Loại giao dịch</legend>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex items-center justify-center border rounded-md p-3 cursor-pointer hover:bg-emerald-50 has-[:checked]:bg-emerald-50 has-[:checked]:border-emerald-500 transition">
                                <input type="radio" name="type" value="income" class="h-4 w-4 text-emerald-600 border-gray-300 focus:ring-emerald-500 mr-2">
                                <span class="text-sm font-medium text-slate-900">Thu Nhập</span>
                            </label>
                            <label class="flex items-center justify-center border rounded-md p-3 cursor-pointer hover:bg-red-50 has-[:checked]:bg-red-50 has-[:checked]:border-red-500 transition">
                                <input type="radio" name="type" value="expense" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500 mr-2" checked>
                                <span class="text-sm font-medium text-slate-900">Chi Tiêu</span>
                            </label>
                        </div>
                    </fieldset>

                    <div class="mb-4" id="descriptionContainer"></div>

                    <div class="mb-4">
                        <label for="amountInput" class="block text-sm font-medium text-slate-700">Số Tiền (VND)</label>
                        <input type="number" id="amountInput" inputmode="numeric" pattern="[0-9]*" min="1" placeholder="Ví dụ: 50000" class="block w-full px-4 py-3 bg-white border border-slate-300 rounded-md text-base focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                    </div>

                    <div class="mb-4">
                        <label for="dateInput" class="block text-sm font-medium text-slate-700">Ngày Giao Dịch</label>
                        <input type="date" id="dateInput" class="mt-1 block w-full px-4 py-3 bg-white border border-slate-300 rounded-md text-base shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                    </div>

                    <div class="mb-6">
                        <label for="customDescriptionInput" class="block text-sm font-medium text-slate-700">Mô Tả Tùy Chỉnh (Tùy chọn)</label>
                        <input type="text" id="customDescriptionInput" placeholder="Ví dụ: Cà phê sáng..." class="mt-1 block w-full px-4 py-3 bg-white border border-slate-300 rounded-md text-base shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                    </div>
                    
                    <button type="submit" id="submitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-4 rounded-lg shadow-md transition duration-300 text-base">
                        Lưu Giao Dịch
                    </button>
                </form>
            </div>
            
            <!-- Chart -->
            <div class="bg-white p-5 rounded-lg shadow-lg flex flex-col order-1 lg:order-2">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-4">Phân Tích Chi Tiêu</h2>
                <p class="text-slate-600 mb-2 text-sm">Phân bổ chi tiêu tháng này.</p>
                <div class="chart-container">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- History -->
        <div class="bg-white p-5 rounded-lg shadow-lg mb-20">
            <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-4">Lịch Sử Giao Dịch</h2>
            <div id="historyList" class="space-y-3">
                <p id="noTransactionText" class="text-slate-500 text-center py-8">Đang tải dữ liệu...</p>
            </div>
        </div>
        
        <!-- Footer actions -->
        <div class="mt-8 mb-8 p-4 text-center bg-slate-50 rounded-lg shadow-inner border border-slate-200">
            <div class="flex flex-col sm:flex-row justify-center gap-3 mb-4">
                <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="window.handleFileImport(event)">
                <button onclick="window.exportDataToJson()" class="w-full sm:w-auto bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-semibold py-3 px-6 rounded-lg shadow-sm transition text-sm flex items-center justify-center">
                    Sao Lưu (JSON)
                </button>
                <button onclick="document.getElementById('importFileInput').click()" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition text-sm flex items-center justify-center">
                    Khôi Phục (JSON)
                </button>
            </div>
            <p class="text-slate-500 text-xs">Dữ liệu lưu tại trình duyệt này.</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="statusModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full text-center">
            <h3 class="text-lg font-medium text-slate-900 mb-2">Thông báo</h3>
            <p id="modalMessage" class="text-sm text-slate-500"></p>
            <button onclick="document.getElementById('statusModal').classList.add('hidden')" class="mt-5 w-full py-2 bg-indigo-600 text-white rounded-md">Đóng</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'finance_app_local_data_v1';
        let sheetTransactions = []; 
        let localTransactions = []; 
        let allTransactions = []; 
        let financeChartInstance = null;

        const balanceDisplay = document.getElementById('balanceDisplay');
        const incomeDisplay = document.getElementById('incomeDisplay');
        const expenseDisplay = document.getElementById('expenseDisplay');
        const historyList = document.getElementById('historyList');
        const noTransactionText = document.getElementById('noTransactionText');
        const chartCanvas = document.getElementById('financeChart').getContext('2d');
        const transactionForm = document.getElementById('transactionForm');

        const SHEET_ID = '1Fs72QcxZIFgYbL62wTvmUgGG9OeEiV_B';
        const GID = '0'; 
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

        function showModal(msg) {
            document.getElementById('modalMessage').textContent = msg;
            document.getElementById('statusModal').classList.remove('hidden');
            document.getElementById('statusModal').classList.add('flex');
        }

        function formatCurrency(val) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(val);
        }

        function parseSheetData(jsonString) {
            const sheetData = [];
            try {
                const match = jsonString.match(/google\.visualization\.Query\.setResponse\(([^;]+)\);/);
                let data = match ? JSON.parse(match[1]).table : null;
                if (data && data.rows) {
                    for (let i = 1; i < data.rows.length; i++) {
                        const c = data.rows[i].c;
                        if (!c[0] || !c[1] || !c[3] || c[3].v === null) continue; 
                        let dStr = '';
                        if (c[0].f) {
                            const f = String(c[0].f).trim();
                            if (f.includes('/')) {
                                const p = f.split('/');
                                if (p.length === 3) dStr = `${p[2]}-${p[1].padStart(2, '0')}-${p[0].padStart(2, '0')}`;
                            } else if (f.length === 10 && f.includes('-')) dStr = f;
                        }
                        if (dStr.length !== 10) continue;
                        sheetData.push({
                            id: `sheet-${i}`, type: (String(c[1].v).toLowerCase().trim() === 'thu' ? 'income' : 'expense'),
                            amount: parseFloat(c[3].v),
                            category: (c[4] && c[4].v ? String(c[4].v) : (c[2] && c[2].v ? String(c[2].v) : 'Khác')).trim(),
                            predefinedCategory: c[2] && c[2].v ? String(c[2].v).trim() : 'Khác',
                            date: dStr
                        });
                    }
                }
            } catch (e) { console.error(e); }
            return sheetData;
        }

        async function fetchSheetData() {
            try {
                const res = await fetch(SHEET_URL);
                const text = await res.text();
                sheetTransactions = parseSheetData(text);
            } catch (e) { sheetTransactions = []; }
        }

        function loadLocal() {
            localTransactions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            updateUI();
        }

        function updateUI() {
            allTransactions = [...sheetTransactions, ...localTransactions];
            noTransactionText.style.display = allTransactions.length === 0 ? 'block' : 'none';
            
            // Calc metrics
            const now = new Date();
            const curM = String(now.getMonth() + 1).padStart(2, '0');
            const curY = String(now.getFullYear());
            let tIn = 0, tEx = 0, curMEx = 0;

            allTransactions.forEach(tx => {
                if (tx.type === 'income') tIn += tx.amount;
                else {
                    tEx += tx.amount;
                    if (tx.date.startsWith(`${curY}-${curM}`)) curMEx += tx.amount;
                }
            });

            balanceDisplay.textContent = formatCurrency(tIn - tEx);
            incomeDisplay.textContent = formatCurrency(tIn);
            expenseDisplay.textContent = formatCurrency(curMEx);
            balanceDisplay.className = `text-2xl md:text-3xl font-bold mt-2 ${(tIn-tEx) >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
            
            renderHistory();
            renderChart(curY, curM);
        }

        function renderChart(curY, curM) {
            const totals = {'Ăn Uống': 0, 'Chi Hàng Tháng': 0, 'Đưa Vợ': 0, 'Khác': 0};
            allTransactions.filter(tx => tx.type === 'expense' && tx.date.startsWith(`${curY}-${curM}`)).forEach(tx => {
                let cat = 'Khác';
                if (['Ăn Sáng', 'Ăn Trưa', 'Ăn Chiều', 'Ăn Tối', 'Ăn Vặt'].includes(tx.predefinedCategory)) cat = 'Ăn Uống';
                else if (['Chi Hàng Tháng', 'Đưa Vợ'].includes(tx.predefinedCategory)) cat = tx.predefinedCategory;
                if (totals.hasOwnProperty(cat)) totals[cat] += tx.amount;
            });
            const labels = Object.keys(totals).filter(k => totals[k] > 0);
            const data = labels.map(k => totals[k]);

            if (financeChartInstance) financeChartInstance.destroy();
            if (data.length === 0) return;
            financeChartInstance = new Chart(chartCanvas, {
                type: 'bar', data: { labels, datasets: [{ data, backgroundColor: 'rgba(239,68,68,0.7)', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        function renderHistory() {
            historyList.innerHTML = '';
            const sorted = [...allTransactions].sort((a, b) => a.date.localeCompare(b.date));
            let balance = 0;
            const groups = {};
            sorted.forEach(tx => {
                balance += tx.amount * (tx.type === 'income' ? 1 : -1);
                const [y, m] = tx.date.split('-');
                if (!groups[y]) groups[y] = {};
                if (!groups[y][m]) groups[y][m] = [];
                groups[y][m].push({ ...tx, runningBalance: balance });
            });

            Object.keys(groups).sort((a, b) => b - a).forEach(y => {
                const yDet = document.createElement('details');
                yDet.className = 'mb-3 bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden';
                yDet.open = (y === new Date().getFullYear().toString());
                const mKeys = Object.keys(groups[y]).sort((a, b) => b - a);
                yDet.innerHTML = `<summary class="flex justify-between p-3 font-bold bg-slate-50">Năm ${y} <span>${formatCurrency(groups[y][mKeys[0]].slice(-1)[0].runningBalance)}</span></summary>`;
                
                mKeys.forEach(m => {
                    const mDet = document.createElement('details');
                    mDet.className = 'border-t border-slate-100';
                    mDet.open = (yDet.open && m === String(new Date().getMonth() + 1).padStart(2, '0'));
                    mDet.innerHTML = `<summary class="flex justify-between p-3 pl-6 text-sm font-semibold">Tháng ${m} <span>Dư: ${formatCurrency(groups[y][m].slice(-1)[0].runningBalance)}</span></summary>`;
                    const cont = document.createElement('div');
                    cont.className = 'px-4 pb-2';
                    [...groups[y][m]].reverse().forEach(tx => {
                        const row = document.createElement('div');
                        row.className = 'flex justify-between items-center py-3 border-b last:border-0';
                        row.innerHTML = `<div class="flex flex-col text-sm"><b>${tx.category}</b><small class="text-slate-400">${tx.date.split('-').reverse().slice(0,2).join('/')}</small></div>
                                         <div class="text-right flex flex-col"><b class="${tx.type==='income'?'text-emerald-600':'text-red-600'}">${tx.type==='income'?'+':'-'} ${formatCurrency(tx.amount)}</b><small class="text-[10px] text-slate-400">Dư: ${formatCurrency(tx.runningBalance)}</small></div>
                                         ${tx.id.startsWith('sheet-')?'':`<button onclick="delTx('${tx.id}')" class="delete-btn ml-2">×</button>`}`;
                        cont.appendChild(row);
                    });
                    mDet.appendChild(cont);
                    yDet.appendChild(mDet);
                });
                historyList.appendChild(yDet);
            });
        }

        window.delTx = (id) => {
            if (confirm("Xóa giao dịch này?")) {
                localTransactions = localTransactions.filter(t => t.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(localTransactions));
                updateUI();
            }
        };

        // --- FIXED EXPORT ---
        window.exportDataToJson = () => {
            // Export ALL transactions currently visible, but formatted cleanly
            const dataToExport = allTransactions.map(tx => ({
                type: tx.type,
                amount: tx.amount,
                category: tx.category,
                predefinedCategory: tx.predefinedCategory,
                date: tx.date
            }));

            if (dataToExport.length === 0) {
                showModal("Không có dữ liệu để sao lưu.");
                return;
            }

            try {
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quan_ly_thu_chi_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showModal("Lỗi khi tạo file sao lưu.");
            }
        };

        window.handleFileImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (!Array.isArray(data)) throw new Error();
                    const imported = data.map(t => ({ ...t, id: `local-${Date.now()}-${Math.random()}` }));
                    localTransactions = [...localTransactions, ...imported];
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(localTransactions));
                    updateUI();
                    showModal(`Đã khôi phục ${imported.length} giao dịch.`);
                } catch { showModal("File không đúng định dạng."); }
            };
            reader.readAsText(file);
        };

        const incomeCats = ['Lương', 'Thưởng', 'Khác'];
        const expenseCats = ['Ăn Sáng', 'Ăn Trưa', 'Ăn Chiều', 'Ăn Tối', 'Ăn Vặt', 'Mua Đồ Online', 'Chi Hàng Tháng', 'Đưa Vợ', 'Đi Chơi', 'Phát Sinh', 'Lặt Vặt'];
        
        function updateCats() {
            const type = document.querySelector('input[name="type"]:checked').value;
            const list = type === 'income' ? incomeCats : expenseCats;
            document.getElementById('descriptionContainer').innerHTML = `<label class="block text-sm font-medium mb-1">Danh Mục</label>
                <select id="catInput" class="block w-full p-3 border rounded-md">${list.map(c => `<option value="${c}">${c}</option>`).join('')}</select>`;
        }

        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('amountInput').value);
            const type = document.querySelector('input[name="type"]:checked').value;
            const cat = document.getElementById('catInput').value;
            const custom = document.getElementById('customDescriptionInput').value.trim();
            localTransactions.push({ id: `local-${Date.now()}`, type, amount, category: custom || cat, predefinedCategory: cat, date: document.getElementById('dateInput').value });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localTransactions));
            transactionForm.reset(); updateCats(); 
            const d = new Date(); document.getElementById('dateInput').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            updateUI();
        });

        async function init() {
            const d = new Date(); document.getElementById('dateInput').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            updateCats();
            document.getElementById('typeSelector').addEventListener('change', updateCats);
            await fetchSheetData();
            loadLocal();
        }
        init();
    </script>
</body>
</html>
